<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter Bag Monitoring System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .toast {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Filter Bag Monitoring</h1>
            <p class="text-gray-600">Sistem Monitoring Multi-Device Real-time</p>
            <div class="flex justify-center items-center mt-4 space-x-4">
                <div class="flex items-center space-x-2">
                    <div id="connectionStatus" class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                    <span id="connectionText" class="text-sm text-gray-600">Menghubungkan...</span>
                </div>
                <div class="text-sm text-gray-500">
                    Online: <span id="onlineCount" class="font-semibold">-</span>
                </div>
            </div>
        </header>

        <!-- Input Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Tambah Data Filter Bag</h2>
            <form id="filterForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label for="bagNumber" class="block text-sm font-medium text-gray-700 mb-2">Nomor Bag</label>
                    <input type="text" id="bagNumber" name="bagNumber" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700 mb-2">Lokasi</label>
                    <input type="text" id="location" name="location" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="status" name="status" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Pilih Status</option>
                        <option value="Baik">Baik</option>
                        <option value="Perlu Perhatian">Perlu Perhatian</option>
                        <option value="Rusak">Rusak</option>
                        <option value="Maintenance">Maintenance</option>
                    </select>
                </div>
                <div>
                    <label for="pressure" class="block text-sm font-medium text-gray-700 mb-2">Tekanan (Bar)</label>
                    <input type="number" id="pressure" name="pressure" step="0.1" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label for="temperature" class="block text-sm font-medium text-gray-700 mb-2">Suhu (¬∞C)</label>
                    <input type="number" id="temperature" name="temperature" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                    <input type="text" id="notes" name="notes" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="md:col-span-2 lg:col-span-3">
                    <button type="submit" 
                            class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 shadow-lg hover:shadow-xl">
                        üíæ Simpan Data
                    </button>
                </div>
            </form>
        </div>

        <!-- Filter Controls -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Filter & Pencarian</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-2">Cari</label>
                    <input type="text" id="searchInput" placeholder="Cari nomor bag, lokasi, atau catatan..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter Status</label>
                    <select id="statusFilter" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Semua Status</option>
                        <option value="Baik">Baik</option>
                        <option value="Perlu Perhatian">Perlu Perhatian</option>
                        <option value="Rusak">Rusak</option>
                        <option value="Maintenance">Maintenance</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="clearFilters" 
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        üóëÔ∏è Reset Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Data Filter Bag</h3>
                    <div class="text-sm text-gray-600">
                        Total: <span id="totalCount" class="font-semibold">0</span> data
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nomor Bag</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tekanan</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Suhu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                        <tr id="noDataRow">
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <div class="text-4xl mb-2">üìä</div>
                                    <div>Belum ada data. Tambahkan data pertama!</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp, connectFirestoreEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAInwF88wMhtqPebcj61HZzBFJX8vCyx8E",
            authDomain: "filterbagmonitoring.firebaseapp.com",
            projectId: "filterbagmonitoring",
            storageBucket: "filterbagmonitoring.firebasestorage.app",
            messagingSenderId: "705867194223",
            appId: "1:705867194223:web:9cd69e36a8eed96d0b929a",
            measurementId: "G-XRC6LVN6GH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let allData = [];
        let onlineUsers = new Set();

        // DOM elements
        const form = document.getElementById('filterForm');
        const tableBody = document.getElementById('dataTableBody');
        const noDataRow = document.getElementById('noDataRow');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const totalCount = document.getElementById('totalCount');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const onlineCount = document.getElementById('onlineCount');

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast px-6 py-3 rounded-lg text-white font-medium shadow-lg ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.className = 'w-3 h-3 bg-green-500 rounded-full';
                connectionText.textContent = 'Terhubung';
            } else {
                connectionStatus.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse';
                connectionText.textContent = 'Terputus';
            }
        }

        // Get status badge class
        function getStatusBadge(status) {
            const badges = {
                'Baik': 'bg-green-100 text-green-800',
                'Perlu Perhatian': 'bg-yellow-100 text-yellow-800',
                'Rusak': 'bg-red-100 text-red-800',
                'Maintenance': 'bg-blue-100 text-blue-800'
            };
            return badges[status] || 'bg-gray-100 text-gray-800';
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Render table
        function renderTable(data = allData) {
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr id="noDataRow">
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <div class="text-4xl mb-2">üìä</div>
                                <div>Belum ada data. Tambahkan data pertama!</div>
                            </div>
                        </td>
                    </tr>
                `;
                totalCount.textContent = '0';
                return;
            }

            const rows = data.map(item => `
                <tr class="hover:bg-gray-50 transition-colors duration-150">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.bagNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.location}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadge(item.status)}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.pressure || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.temperature || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatTimestamp(item.timestamp)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="deleteItem('${item.id}')" 
                                class="text-red-600 hover:text-red-900 transition-colors duration-150">
                            üóëÔ∏è Hapus
                        </button>
                    </td>
                </tr>
            `).join('');

            tableBody.innerHTML = rows;
            totalCount.textContent = data.length;
        }

        // Filter data
        function filterData() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusTerm = statusFilter.value;

            const filtered = allData.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.bagNumber.toLowerCase().includes(searchTerm) ||
                    item.location.toLowerCase().includes(searchTerm) ||
                    (item.notes && item.notes.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusTerm || item.status === statusTerm;
                
                return matchesSearch && matchesStatus;
            });

            renderTable(filtered);
        }

        // Add data to Firebase
        async function addData(data) {
            try {
                await addDoc(collection(db, 'filterBags'), {
                    ...data,
                    timestamp: serverTimestamp()
                });
                showToast('Data berhasil disimpan!');
            } catch (error) {
                console.error('Error adding document: ', error);
                showToast('Gagal menyimpan data!', 'error');
            }
        }

        // Delete data from Firebase
        window.deleteItem = async function(id) {
            try {
                await deleteDoc(doc(db, 'filterBags', id));
                showToast('Data berhasil dihapus!');
            } catch (error) {
                console.error('Error deleting document: ', error);
                showToast('Gagal menghapus data!', 'error');
            }
        };

        // Listen to Firebase changes
        function setupRealtimeListener() {
            const unsubscribe = onSnapshot(
                collection(db, 'filterBags'), 
                (snapshot) => {
                    updateConnectionStatus(true);
                    allData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Sort by timestamp (newest first)
                    allData.sort((a, b) => {
                        if (!a.timestamp) return 1;
                        if (!b.timestamp) return -1;
                        return b.timestamp.seconds - a.timestamp.seconds;
                    });
                    
                    filterData();
                },
                (error) => {
                    console.error('Error listening to changes: ', error);
                    updateConnectionStatus(false);
                    showToast('Koneksi terputus!', 'error');
                }
            );

            return unsubscribe;
        }

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const data = {
                bagNumber: formData.get('bagNumber'),
                location: formData.get('location'),
                status: formData.get('status'),
                pressure: formData.get('pressure') || null,
                temperature: formData.get('temperature') || null,
                notes: formData.get('notes') || ''
            };

            await addData(data);
            form.reset();
        });

        // Filter event listeners
        searchInput.addEventListener('input', filterData);
        statusFilter.addEventListener('change', filterData);
        clearFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            statusFilter.value = '';
            filterData();
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            setupRealtimeListener();
            
            // Simulate online users (for demo)
            setInterval(() => {
                const count = Math.floor(Math.random() * 5) + 1;
                onlineCount.textContent = count;
            }, 10000);
            
            onlineCount.textContent = '1';
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98fc747f86bc410c',t:'MTc2MDY2OTA3Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
