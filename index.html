// Supabase Configuration
const SUPABASE_URL = 'https://ppaewszxnndnlnjfvdkl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwYWV3c3p4bm5kbmxuamZ2ZGtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2Nzc5MjIsImV4cCI6MjA3NjI1MzkyMn0.rpfnaRHlJg0C5Y4QvHXmAbIo9a7l5VBTFJfzrOckEDY';

// Initialize Supabase client
let supabaseClient;

// Constants
const MAX_FILTERS = 300;
const WARNING_THRESHOLD = 230;

// Initialize app
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Initialize Supabase
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Setup tabs
        setupTabs();
        
        // Load data
        await loadDashboardData();
        await loadHistory();
        
        // Setup forms
        setupForms();
        
        // Setup realtime
        setupRealtimeSubscription();
        
        console.log('App initialized successfully');
    } catch (error) {
        console.error('Error initializing app:', error);
        showToast('Error memuat aplikasi', 'error');
    }
});

function setupTabs() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
        });
    });
}

function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Find and activate clicked tab
    const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeTab) {
        activeTab.classList.add('active');
    }
    
    // Update sections
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    const targetSection = document.getElementById(tabName + '-section');
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // Load history if history tab is selected
    if (tabName === 'history') {
        loadHistory();
    }
}

async function loadDashboardData() {
    try {
        const { data: filterData, error } = await supabaseClient
            .from('filter_counters')
            .select('*');
        
        if (error && error.code !== 'PGRST116') {
            throw error;
        }
        
        updateDashboard(filterData || []);
    } catch (error) {
        console.error('Error loading dashboard:', error);
        updateDashboard([]);
        showToast('Error memuat dashboard', 'error');
    }
}

function updateDashboard(filterData) {
    const filterGrid = document.getElementById('filterGrid');
    if (!filterGrid) return;
    
    const machines = ['FBD Y 60', 'FBD Y 150', 'FBD Glatt'];
    const filterTypes = ['warna', 'putih'];
    
    let html = '';
    
    machines.forEach(machine => {
        filterTypes.forEach(filterType => {
            const filterInfo = filterData.find(f => f.machine === machine && f.filter_type === filterType);
            const usage = filterInfo ? filterInfo.usage_count : 0;
            
            const remaining = Math.max(0, MAX_FILTERS - usage);
            const percentage = Math.round((usage / MAX_FILTERS) * 100);
            
            let cardClass = 'filter-card';
            if (usage >= WARNING_THRESHOLD) {
                if (usage >= MAX_FILTERS) {
                    cardClass += ' critical';
                } else {
                    cardClass += ' warning';
                }
            }
            
            html += `
                <div class="${cardClass}">
                    <div class="filter-header">
                        <div class="filter-title">${machine}</div>
                        <div class="filter-type-badge ${filterType}">${filterType.toUpperCase()}</div>
                    </div>
                    <div class="filter-stats">
                        <div class="filter-stat">
                            <div class="filter-stat-number">${usage}</div>
                            <div class="filter-stat-label">Terpakai</div>
                        </div>
                        <div class="filter-stat">
                            <div class="filter-stat-number">${remaining}</div>
                            <div class="filter-stat-label">Sisa</div>
                        </div>
                        <div class="filter-stat">
                            <div class="filter-stat-number">${percentage}%</div>
                            <div class="filter-stat-label">Persentase</div>
                        </div>
                    </div>
                </div>
            `;
        });
    });
    
    filterGrid.innerHTML = html;
}

async function loadHistory() {
    const historyContainer = document.getElementById('historyContainer');
    if (!historyContainer) return;
    
    try {
        historyContainer.innerHTML = '<div class="loading">Memuat riwayat...</div>';
        
        const { data: historyData, error } = await supabaseClient
            .from('activity_history')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(20);
        
        if (error && error.code !== 'PGRST116') {
            throw error;
        }
        
        displayHistory(historyData || []);
    } catch (error) {
        console.error('Error loading history:', error);
        historyContainer.innerHTML = '<div class="loading">Error memuat riwayat</div>';
    }
}

function displayHistory(historyData) {
    const historyContainer = document.getElementById('historyContainer');
    if (!historyContainer) return;
    
    if (historyData.length === 0) {
        historyContainer.innerHTML = '<div class="loading">Belum ada riwayat aktivitas</div>';
        return;
    }
    
    const historyHTML = historyData.map(item => {
        const date = new Date(item.created_at);
        const timeStr = date.toLocaleString('id-ID', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        let typeLabel = '';
        let details = '';
        
        switch(item.activity_type) {
            case 'usage':
                typeLabel = 'PEMAKAIAN';
                details = `<strong>${item.operator}</strong> menggunakan filter ${item.filter_type} pada mesin <strong>${item.machine}</strong>`;
                break;
            case 'replacement':
                typeLabel = 'PENGGANTIAN';
                details = `<strong>${item.operator}</strong> mengganti filter ${item.filter_type} pada mesin <strong>${item.machine}</strong> dengan vendor <strong>${item.vendor}</strong>`;
                break;
            case 'destroy':
                typeLabel = 'PEMUSNAHAN';
                details = `<strong>${item.operator}</strong> memusnahkan filter ${item.filter_type} pada mesin <strong>${item.machine}</strong>`;
                break;
        }
        
        return `
            <div class="history-item ${item.activity_type}">
                <div class="history-time">${timeStr}</div>
                <div class="history-details">
                    <span class="history-type ${item.activity_type}">${typeLabel}</span>
                    ${details}
                </div>
            </div>
        `;
    }).join('');
    
    historyContainer.innerHTML = historyHTML;
}

function setupForms() {
    // Usage Form
    const usageForm = document.getElementById('usageForm');
    if (usageForm) {
        usageForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleFormSubmit(e, 'usage');
        });
    }
    
    // Replacement Form
    const replacementForm = document.getElementById('replacementForm');
    if (replacementForm) {
        replacementForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleFormSubmit(e, 'replacement');
        });
    }
    
    // Destroy Form
    const destroyForm = document.getElementById('destroyForm');
    if (destroyForm) {
        destroyForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleFormSubmit(e, 'destroy');
        });
    }
}

async function handleFormSubmit(e, type) {
    const form = e.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    
    const operator = formData.get('operator').trim();
    const machine = formData.get('machine');
    const filterType = formData.get('filterType');
    const vendor = formData.get('vendor');
    
    if (!operator || !machine || !filterType) {
        showToast('Mohon lengkapi semua field', 'error');
        return;
    }
    
    if (type === 'replacement' && !vendor) {
        showToast('Nama vendor harus diisi', 'error');
        return;
    }
    
    submitBtn.disabled = true;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '⏳ Menyimpan...';
    
    try {
        // Add to history
        const historyData = {
            activity_type: type,
            operator: operator,
            machine: machine,
            filter_type: filterType,
            created_at: new Date().toISOString()
        };
        
        if (type === 'replacement') {
            historyData.vendor = vendor;
        }
        
        const { error: historyError } = await supabaseClient
            .from('activity_history')
            .insert([historyData]);
        
        if (historyError) throw historyError;
        
        // Update usage counter
        await updateUsageCounter(type, machine, filterType);
        
        // Reset form
        form.reset();
        
        // Reload data
        await loadDashboardData();
        await loadHistory();
        
        let message = '';
        switch(type) {
            case 'usage':
                message = '✅ Pemakaian berhasil dicatat!';
                break;
            case 'replacement':
                message = '✅ Penggantian berhasil dicatat! Counter direset.';
                break;
            case 'destroy':
                message = '✅ Pemusnahan berhasil dicatat!';
                break;
        }
        
        showToast(message);
        
    } catch (error) {
        console.error('Error saving data:', error);
        showToast('❌ Error menyimpan data: ' + error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

async function updateUsageCounter(type, machine, filterType) {
    const { data: currentFilter, error: fetchError } = await supabaseClient
        .from('filter_counters')
        .select('*')
        .eq('machine', machine)
        .eq('filter_type', filterType)
        .single();
    
    let newCount = 0;
    
    if (fetchError && fetchError.code !== 'PGRST116') {
        throw fetchError;
    }
    
    if (type === 'usage') {
        // Increment usage
        newCount = currentFilter ? (currentFilter.usage_count || 0) + 1 : 1;
    } else if (type === 'replacement') {
        // Reset to 0 on replacement
        newCount = 0;
    } else if (type === 'destroy') {
        // Keep current count for destroy
        newCount = currentFilter ? (currentFilter.usage_count || 0) : 0;
    }
    
    if (currentFilter) {
        const { error: updateError } = await supabaseClient
            .from('filter_counters')
            .update({ usage_count: newCount })
            .eq('machine', machine)
            .eq('filter_type', filterType);
        
        if (updateError) throw updateError;
    } else {
        const { error: insertError } = await supabaseClient
            .from('filter_counters')
            .insert([{ 
                machine: machine, 
                filter_type: filterType, 
                usage_count: newCount 
            }]);
        
        if (insertError) throw insertError;
    }
}

function setupRealtimeSubscription() {
    if (!supabaseClient) return;
    
    try {
        // Subscribe to activity history changes
        supabaseClient
            .channel('activity_changes')
            .on('postgres_changes', 
                { event: 'INSERT', schema: 'public', table: 'activity_history' }, 
                () => {
                    loadHistory();
                }
            )
            .subscribe();
        
        // Subscribe to filter counter changes
        supabaseClient
            .channel('filter_changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'filter_counters' }, 
                () => {
                    loadDashboardData();
                }
            )
            .subscribe();
            
        console.log('Realtime subscriptions established');
    } catch (error) {
        console.error('Error setting up realtime:', error);
    }
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    if (!toast) {
        console.log('Toast:', message);
        return;
    }
    
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Expose switchTab to global scope for onclick
window.switchTab = switchTab;
